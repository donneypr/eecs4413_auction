name: Deploy to k3s (self-hosted)

on:
  workflow_run:
    workflows: ["Build & Push Images"]
    types: [completed]
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: deploy-eecs4413_auction
  cancel-in-progress: true

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: [self-hosted, main-k3s]
    env:
      KUBECONFIG: /home/pve1/.kube/config
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Verify kubectl
        run: kubectl version --client=true
      - name: Remove old/conflicting ingresses
        run: |
          kubectl delete ingress hello auction-web auction -n default --ignore-not-found
      # Apply all app manifests (Config/Secrets, DB, backend, frontend, ingress)
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k3s/0-config.yaml
          kubectl apply -f k3s/1-mysql.yaml || true   # ok to skip if you use external DB
          kubectl apply -f k3s/2-backend.yaml
          kubectl apply -f k3s/3-frontend.yaml
          kubectl apply -f k3s/4a-mw-strip-api.yaml
          kubectl apply -f k3s/4-ingress.yaml
      - name: Run DB migrations
        run: |
          kubectl delete job backend-migrate -n default --ignore-not-found
          kubectl apply -f k3s/5-migrate.yaml
          kubectl wait --for=condition=complete job/backend-migrate -n default --timeout=600s
      - name: Set backend image to this commit SHA and roll out
        env:
          REPO_LC: ${{ github.event.repository.name }}
        run: |
          HEAD_SHA='${{ github.event.workflow_run.head_sha }}'
          SHORT_SHA=${HEAD_SHA::7}
          IMAGE="ghcr.io/${{ github.repository_owner }}/$(echo "$REPO_LC" | tr '[:upper:]' '[:lower:]')-backend:sha-${SHORT_SHA}"
          echo "Deploying $IMAGE"
          kubectl set image deploy/auction-backend backend=$IMAGE -n default
          kubectl rollout status deploy/auction-backend -n default --timeout=180s
      # Since images are tagged ":latest", restart to pull the newest
      - name: Restart rollouts
        run: |
          kubectl rollout restart deployment/auction-backend
          kubectl rollout status  deployment/auction-backend --timeout=180s
          kubectl rollout restart deployment/auction-frontend
          kubectl rollout status  deployment/auction-frontend --timeout=180s